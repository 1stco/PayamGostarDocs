## Custom Expression

در حال حاضر، در فعالیت‌ تخصیص مقدار، چندشرطی و اجرای دستورات پایگاه داده می توان از  Custom Expression استفاده نمود که ساختار کلی آن با زبان C#  در کتابخانه linq مشابهت دارد.

می‌توانید با تعریف Expression در این فعالیت‌ها، در طی فرآیند، اطلاعاتی را از دیتابیس دریافت کرده و خروجی آن را در فیلد مورد نظر خود مشاهده کنید.

**syntaxهای کلیدی:**

1.	Select: برای انتخاب خروجی موردنظر جهت /مشاهده، از این دستور استفاده می شود.

2.	This: استفاده از این عبارت به معنای ارجاع دادن به موجودیت فعلی (موجودیت تحت فرآیند) می‌باشد.

3.	Children: استفاده از این عبارت به معنای ارجاع دادن به سوابق موجودیت فعلی می‌باشد.

4.	Parent: استفاده از این عبارت به معنای ارجاع دادن به موجودیتی می‌باشد که موجودیت فعلی در سوابق آن ثبت شده است.

نکته : در صورتی که بخواهید از اطلاعات  موجودیت (هویت) Identity خروجی بگیرید،  لزومی ندارد برای ارجاع دادن از عبارت Parent  استفاده کنید، در حالی که در سایر موجودیت ها باید  از عبارت Parent استفاده کنید.

5.	Where: برای گذاشتن شرط از این دستور استفاده می شود.

6. Order: برای مرتب کردن نتایج، به صورت صعودی استفاده می شود.

7. OrderDes: برای مرتب کردن نتایج، به  صورت نزولی استفاده می شود.

8. Take: برای انتخاب خروجی مورد نظر، از نتایج مرتب شده (توسط دستور Order  یا OrderDes) استفاده می شود.

9. TakeOrDefault: برای انتخاب خروجی مورد نظر، از نتایج مرتب شده (توسط دستور Order  یا OrderDes) استفاده می شود، در این حالت در صورتی که خروجی مورد نظر وجود نداشته باشد، می¬توانیم از مقدار پیش فرض تعریف شده برای خروجی استفاده کنیم.

10.	&&: برای تعریف چندین شرط، بین شرط‌های موردنظر خود در where استفاده کنید.

11.	||: برای تعریف "یا" بین شرط‌های موردنظر از این where استفاده کنید. 

**نحوه نوشتن Expression: **

Expression موردنظر باید بصورت @(Expression);  در فعالیت مربوطه تعریف شود که به صورت فراخوانی متوالی توابع فوق با استفاده از "." صورت می گیرد.

> **نکته:** در فعالیت اجرای دستورات پایگاه داده، در صورت نیاز به استفاده از Expression باید به صورت   select @( Expression); نوشته شود.

![](sql1.png)

**نمونه‌هایی از نحوه‌ی تعریفExpression :**

حال در این قسمت با مثال هایی طریقه نوشتن Expression  آموزش داده می شود:

![](sql2.png)

> نکته: می‌توانید از children یا parent  بعد از this  یا در where  استفاده کنید و تفاوتی در دستور ندارد. (نمونه 3 و 4)

> نکته: در نوشتن Expression هنگامی که از children استفاده شود، بصورت پیش‌فرض اولین سابقه‌ی موجودیت فعلی در نظر گرفته می شود. توجه داشته باشید منظور از اولین، اولین سابقه ایی است که یافت شود، لذا بر اساس تاریخ نمی باشد.

در حالی که بخواهید بر اساس تاریخ یا فیلد مورد نظر باشد باید از دستورات Order  یا OrderDes استفاده کنید، برای مثال با این دستور اولین فرم موجود در سابقه‌ی آیتم جاری  به ترتیب تاریخ انتخاب شده و عنوان آن فرم به عنوان خروجی انتخاب می¬شود.

SELECT @(this.SELECT(Children.Form.Subject).Order(Children.Form. CreateDate).Take(1));

در صورتی که بخواهیم عنوان سومین فرم انتخاب شود در حالی که  اگر فرمی وجود نداشت مقدار عددی 0 به ما داده شود از دستور زیر استفاده می¬کنیم.

SELECT @(this.SELECT(Children.Form.Subject).Order(Children.Form. CreateDate).TakeOrDefault(3,"0"));

> نکته: در فعالیت تخصیص مقدار و چندشرطی تنها می‌توان از آیتم جاری، سابقه آیتم جاری و پدر آیتم جاری اطلاعاتی را دریافت و در خروجی مشاهده کرد. به این معنی که اگر سابقه آیتم جاری دارای فیلد اضافه‌ای از نوع آیتم سی آر ام، مانند "فرم" باشد، فقط می‌توان خود فرم را در خروجی مشاهده کرد و نمی توان از درون آن فرم اطلاعاتی را دریافت کرد.

> نکته: لازم به ذکر است در صورت استفاده از Expression در فعالیت‌های تخصیص مقدار و تصمیم چندشرطی باید نوع فیلدی که برای مقدار دهی انتخاب می‌شود با نوع آن فیلدی که به عنوان مبدا می‌باشد، یکسان باشد. در جدول تعاریف فیلدهای موجودیت ها، نوع فیلدهای پیش فرض سیستم(PropertyDisplayName) آورده شده اند. 

> نکته: هنگام نوشتن دستور به بزرگ و کوچک بودن حروف دقت کنید.

**مثال 1:**

@(this.Select(Subject));

با این دستور مقدار عنوان آیتم جاری(آیتم تحت فرآیند) برگردانده می شود

**مثال 2:**

@(this.Identity.Select(Email));

با این دستور فیلد ایمیل هویت مرتبط با آیتم جاری(آیتم تحت فرآیند)برگردانده می شود.

**مثال 3:**

@(this.Identity.Select(pphali));

با این دستور مقدار فیلد اضافه‌ای با  کلید pphali که در هویت مرتبط با آیتم جاری موجود می باشد برگردانده می‌شود.

**مثال 4:**

@(this.frmk.Form.Select(customerno));

طبق این مثال در موجودیت فعلی فیلد اضافه‌ای با کلید frmk  از نوع "فرم" وجود دارد، که این فرم نیز دارای فیلد اضافه‌ای با کلید customerno می‌باشد و مقدار این فیلد از طریق دستور فوق برگردانده می شود.

**نکته:** در صورتیکه فیلد مربوطه از نوع "آیتم های CRM " باشد، باید نوع آیتم نیز بعد از کلید کاربر فیلد نوشته شود.

این دستور را می توان به این شکل نیز تعریف کرد: 

@(this.Select(frmk.Form.customerno));

**مثال 5:**

@(this.Select(Children.Ticket.EmailAddress)); 

طبق این مثال در موجودیت فعلی سابقه درخواست پشتیبانی وجود دارد و طبق آن مقدار فیلد آدرس ایمیل از این سابقه برگردانده می¬شود.

این دستور را می توان به این شکل نیز نوشت:

@(this.Children.Select(Ticket.EmailAddress));

**مثال 6:**

@(this.Parent.Select(Opportunity.RealizedValue));

با این دستور فیلد مبلغ محقق شده فرصت که آیتم جاری (آیتم تحت فرآیند) در سابقه آن ثبت شده است، برگردانده می‌شود.

**مثال 7:** 

@(this.Where(Children.Form.Subject =="فرم دوم" ).Select(Children.Form.polformat));

با این دستور مقدار فیلد اضافه‌ای با کلید polformat که در فرم موجود در سابقه‌ی آیتم جاری وجود دارد برگردانده می¬شود، با این شرط که عنوان فرم "فرم دوم" باشد. 


**مثال 8:**

@(this.Where(Children.Form.number == 99).Select(Children.Form.polformat));

با این دستور فیلد انتخاب شده با مقدار فیلد اضافه‌ای با کلید polformat که در فرم موجود در سابقه آیتم جاری وجود دارد مقداردهی می‌شود، با شرط این که در آن فرم فیلدی با کلید number  دارای مقدار 99 باشد.

**مثال 9:**

@(this.Where(Children.Form.number == 670 || Children.Form.poljoin == 400).Select(Children.Form.polformat));

با این دستور فیلد انتخاب شده با مقدار فیلد اضافه‌ای با کلید polformat که در فرم موجود در سوابقه‌ی آیتم جاری وجود دارد مقدار دهی می‌شود، با این شرط که در آن فرم فیلدی با کلید number دارای مقدار 670 باشد یا فیلدی با کلید poljoin دارای مقدار 400 باشد. 

**مثال 10:**

@(this.Form.Where(Children.number == 90 && (Children.poljoin == 30 || Children.numfirst == 18)).Select(Children.Form.polformat));

با این دستور فیلد انتخاب شده با مقدار فیلد اضافه‌ای با کلید polformat که در فرم موجود در سابقه‌ی آیتم جاری وجود دارد مقداردهی می‌شود، با این شرط که در آن فرم فیلدی با کلید npfali دارای مقدار 90  و فیلدی با کلید poljoin دارای مقدار 30 باشد یا فیلدی با کلید numfirst دارای مقدار 18 باشد. 

**مثال 11:** 

@(this.Where(Children.Form.ModifyDate >= Convert.ToDateTime("2020-08-31") && Children.Form.ModifyDate <= Convert.ToDateTime("2020-09-01")).Select(Children.Form.polformat));

با این دستور فیلد انتخاب شده با مقدار فیلد اضافه‌ای با کلید polformat که در فرم موجود در سابقه‌ی آیتم جاری وجود دارد مقدار دهی می‌شود با این شرط که تاریخ ویرایش این سابقه بزرگ تر مساوی "2020-08-31" یا کوچیک تر مساوی "2020-09-01" باشد.

**مثال 12:**

@(this.Where(Children.Type.Code == "FR123").Select(Children.Form.polformat));

با این دستور فیلدی با کلید polformat که در موجودیتی با کلید FR123 که در سابقه‌ی آیتم جاری وجود دارد، برگردانده می¬شود.

**توجه:**: در صورت نیاز به نوشتن اکسپرشن، کلید فیلدها و موجودیت¬ها در نرم افزار می بایست یکتا باشند. 

**مثال 13:**

@(this.Where(Children.Invoice.BillableObjectTypeindex == 8).Select(Children.Invoice.FinalValue));

با این دستور فیلد مبلغ نهایی فاکتور برگشت از فروش که در سابقه آیتم جاری وجود دارد، برگردانده می شود.

**مثال 14:**

@(this.Where(Children.Invoice.BillableObjectTypeindex == 7).Select(Children.Invoice.FinalValue));

با این دستور فیلد مبلغ نهایی فاکتور برگشت از خرید که در سابقه آیتم جاری وجود دارد، برگردانده می شود.

لیست فیلدهای قابل پشتیبانی جهت تعیین مقدار از طریق Expression:

•	Html

•	پول

•	تاریخ شمسی

•	تاریخ میلادی

•	چک باکس

•	ساعت 

•	عدد

•	کاربر

•	گروه

•	لینک

•	متن 

•	شرکت/شخص


