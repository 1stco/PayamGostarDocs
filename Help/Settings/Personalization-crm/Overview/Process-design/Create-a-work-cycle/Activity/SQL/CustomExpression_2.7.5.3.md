# راهنمای استفاده از Custom Expression در فرآیند
در این بخش به موضوعات زیر می‌پردازیم:
- [کاربرد و اهمیت استفاده از Expression](#WhatIsExpression)
- [دستورات Expression در کدام فعالیت‌های سیستمی قابل اجرا هستند؟](#ExpressionInProcessActivity)
- [کدام آیتم‌های CRM امکان استفاده از Expression را دارند؟](#ExpressionOnCRMObjects)
- [روی کدام فیلدها امکان استفاده از Expression وجود دارد؟](#ValidFieldInExpression)
- [ساختار Expression و نحوه استفاده از آن](#ExpressionSyntax)
- [نمونده‌هایی از Expressionهای استفاده شده در فرآیندها](#SamplesForExpression)

## کاربرد و اهمیت استفاده از Expression{#WhatIsExpression}
Custom Expression شامل دستوراتی است که ساختار کلی آن با زبان #C در کتابخانه Linq نوشته شده است.<br>
از این دستورات می‌توانید در طی فرآیند اطلاعاتی را از دیتابیس دریافت کرده و خروجی آن را در فیلدهای مقصد مورد نظر خود مشاهده کنید.

## دستورات Expression در کدام فعالیت‌های سیستمی قابل اجرا هستند؟{#ExpressionInProcessActivity}
در حال حاضر، در فعالیت‌های **تخصیص مقدار**، **چند شرطی** و **اجرای دستورات پایگاه‌داده** می‌توان از  Custom Expression استفاده نمود که ساختار کلی آن با زبان C#  در کتابخانه linq مشابهت دارد.<br>

## کدام آیتم‌های CRM امکان استفاده از Expression را دارند؟{#ExpressionOnCRMObjects}
در حال حاضر قابلیت اجرای دستورات Expression روی آیتم‌های زیر امکان پذیر است:
- فرم
- فرصت
- هویت
- وظیفه
- درخواست پشتیبانی
- پیش‌فاکتور خرید/فروش
- فاکتور خرید/فروش
- فاکتور برگشت از خرید/فروش

## روی کدام فیلدها امکان استفاده از Expression وجود دارد؟{#ValidFieldInExpression}
فیلدهایی که در ادامه به آن اشاره شد، قابلیت این را دارند که از طریق دستورات Expression در حین فرآیند مقداری به آن تخصیص داده شود:
- Html
- پول
- تاریخ شمسی
- تاریخ میلادی
- چک باکس
- ساعت 
- عدد
- متن
- کاربر
- گروه
- لینک
- شرکت/شخص

> **نکته**<br>
> در نسخه‌های قبل برای استفاده از Expression در انتقال اطلاعات بین فیلدها، لازم بود نوع فیلد **مبدأ** و **مقصد** یکسان باشد. اکنون در حالتی که **فیلد مقصد از نوع متن (Text)** باشد، نوع فیلد مبدأ اهمیتی نداشته و انتقال اطلاعات انجام می‌شود.

## ساختار Expression و نحوه استفاده از آن{#ExpressionSyntax}
برای استفاده از Custom Expression در فرآیندها، Syntaxهای اصلی‌ای وجود دارد که شامل موارد زیر است:

1. **This:** استفاده از این عبارت به معنای ارجاع دادن به موجودیت فعلی **(آیتمی که فرآیند را روی آن می‌سازید)** است.
2. **Select:** برای انتخاب **خروجی موردنظر** جهت مشاهده، از این دستور استفاده می‌شود.
3. **Children:** استفاده از این عبارت به معنای ارجاع دادن به **سوابق موجودیت فعلی** می‌باشد.

>**نکته**<br>
> در نوشتن Expression هنگامی‌که از **children** استفاده شود، به‌صورت پیش‌فرض اولین سابقه‌ی موجودیت فعلی در نظر گرفته می‌شود. توجه داشته باشید منظور از اولین، اولین سابقه‌ای است که **یافت شود**، لذا بر اساس **تاریخ نمی‌باشد**.

4. **Parent:** استفاده از این عبارت به معنای ارجاع دادن به موجودیتی می‌باشد که موجودیت فعلی در سوابق آن ثبت شده است (آیتم پدر)

>**نکته**<br> 
>درصورتی‌که بخواهید از اطلاعات موجودیت (هویت) Identity خروجی بگیرید، لزومی ندارد برای ارجاع دادن از عبارت Parent  استفاده کنید، درحالی‌که در سایر موجودیت‌ها باید از عبارت Parent استفاده کنید.

![Expression](Customparent.png)

**5. Where:** برای گذاشتن شرط از این دستور استفاده می‌شود.<br>

>**نکته**<br>
>می‌توانید از children یا parent  بعد از this  یا در where  استفاده کنید و تفاوتی در دستور ندارد. (گزینه‌های 3 و 4)

**6. Order:** برای مرتب کردن نتایج، به‌صورت صعودی استفاده می‌شود.<br>
**7. OrderDes:** برای مرتب کردن نتایج، به‌صورت نزولی استفاده می‌شود.<br>
**8. Take:** برای انتخاب خروجی موردنظر، از نتایج مرتب شده (توسط دستور Order  یا OrderDes) استفاده می‌شود.<br>
**9.TakeOrDefault:** برای انتخاب خروجی موردنظر، از نتایج مرتب شده (توسط دستور Order  یا OrderDes) استفاده می‌شود، در این حالت درصورتی‌که خروجی موردنظر وجود نداشته باشد، می‌توانیم از مقدار پیش‌فرض تعریف شده برای خروجی استفاده کنیم.<br>
**10. &&:** برای تعریف چندین شرط، بین شرط‌های موردنظر خود در where استفاده کنید.<br>
**11. ||:** برای تعریف "یا" بین شرط‌های موردنظر از این where استفاده کنید.<br>

> **نکته**{#ItemKey}<br>
> برای فراخوانی اطلاعات از **فیلدهای اضافه‌ی** آیتم‌ها، باید **کلید کاربر آیتمی** که اطلاعات آن را فراخوانی می‌کنید را در انتهای دستور اضافه کنید.
>> ; (this.Item.Select(ExtendedField@**ItemKey**))@

Expression موردنظر باید به‌صورت ; (Expression)@ در فعالیت مربوطه تعریف شود که به‌صورت فراخوانی متوالی توابع فوق با استفاده از "." صورت می‌گیرد.

> **نکته**<br>
> در فعالیت اجرای دستورات پایگاه‌داده، در صورت نیاز به استفاده از Expression باید به‌صورت ; (Expression)@ نوشته شود.

![شیوه نوشتن دستور](Expression1.png)

### نمونه‌هایی از نحوه‌ی تعریف Expression
در این قسمت با مثال‌هایی طریقه نوشتن Expression آموزش داده می‌شود:

#### مثال 1:<br>
درحالی‌که بخواهید **بر اساس تاریخ یا فیلد موردنظر** Children انتخاب شود، باید از دستورات  **Order**  یا **OrderDes** استفاده کنید، برای مثال با این دستور ***اولین فرم موجود در سابقه‌ی آیتم جاری به ترتیب تاریخ انتخاب شده*** و عنوان آن فرم به‌عنوان خروجی انتخاب می‌شود.

	@(this.SELECT(Children.Form.Subject).Order(Children.Form.CreateDate).Take(1));


درصورتی‌که بخواهیم عنوان **سومین فرم** انتخاب شود درصورتی که اگر فرمی وجود نداشت مقدار عددی 0 به ما داده شود از دستور زیر استفاده می‌کنیم.


	@(this.SELECT(Children.Form.Subject).Order(Children.Form. CreateDate).TakeOrDefault(3,"0"));

>**نکته**<br>
> ‌در فعالیت‌های **تخصیص مقدار** و **چند شرطی** تنها می‌توان از **آیتم جاری، سابقه آیتم جاری و پدر آیتم جاری** اطلاعاتی را دریافت و در خروجی مشاهده کرد. به این معنی که اگر سابقه آیتم جاری دارای فیلد اضافه‌ای از نوع آیتم CRM، مانند "فرم" باشد، فقط می‌توان خود فرم را در خروجی مشاهده کرد و نمی‌توان از درون آن فرم اطلاعاتی را دریافت کرد.

>**نکته**<br>
>لازم به ذکر است در صورت استفاده از Expression در فعالیت‌های تخصیص مقدار و تصمیم چند شرطی باید نوع فیلدی که برای مقداردهی انتخاب می‌شود با نوع آن فیلدی که به‌عنوان مبدأ می‌باشد، یکسان باشد. در جدول تعاریف فیلدهای موجودیت‌ها، نوع فیلدهای پیش‌فرض سیستم (PropertyDisplayName) آورده شده‌اند. 

>**نکته**<br>
>هنگام نوشتن دستور به بزرگ و کوچک بودن حروف دقت کنید.

#### مثال 2:<br>
با این دستور مقدار **عنوان آیتم جاری** (آیتم تحت فرایند) برگردانده می‌شود.

	@(this.Select(Subject));

#### مثال 3:<br>
با این دستور **فیلد ایمیل هویت مرتبط** با آیتم جاری (آیتم تحت فرایند) برگردانده می‌شود.

	@(this.Identity.Select(Email));

#### مثال 4:<br>
با این دستور مقدار **فیلد اضافه‌ای** با کلید pphali که در هویت مرتبط با آیتم جاری با کلید کاربر typeali موجود می‌باشد، برگردانده می‌شود.

	@(this.Identity.Select(pphali@typeali));

#### مثال 5:<br> 
طبق این مثال در موجودیت فعلی با کلید کاربری myformtype  فیلد اضافه‌ی رفرنسی با کلید frmk از نوع فرم وجود دارد که این فرم نیز دارای فیلد اضافه‌ای با کلید customerno در فرمی از نوع دیگر با کلید کاربری otherformtype می‌باشد و مقدار این فیلد از طریق دستور فوق برگردانده می‌شود.

	@(this.frmk@myformtype.Form.Select(customerno@otherformtype));


> **نکته:**<br> 
>درصورتی‌که فیلد مربوطه از **نوع** "آیتم‌های CRM " باشد، باید نوع آیتم نیز بعد از **کلید کاربری آیتم**، نوشته شود.
 
 این دستور را می‌توان به این شکل نیز تعریف کرد:

	 @(this.Select(frmk@myformtype.Form.customerno@otherformtype));

#### مثال 6:<br>
طبق این مثال در موجودیت فعلی سابقه درخواست پشتیبانی وجود دارد و طبق آن مقدار فیلد آدرس ایمیل از این سابقه برگردانده می‌شود.

	@(this.Select(Children.Ticket.EmailAddress)); 

این دستور را می‌توان به این شکل نیز نوشت:

	@(this.Children.Select(Ticket.EmailAddress));

#### مثال 7:<br>
با این دستور فیلد مبلغ محقق شده فرصت، که آیتم جاری (آیتم تحت فرایند) در سابقه‌ی آن ثبت شده است، برگردانده می‌شود.

	@(this.Parent.Select(Opportunity.RealizedValue));

#### مثال 8:<br>
با این دستور مقدار فیلد اضافه‌ای با کلید polformat که در فرم موجود در سابقه‌ی آیتم جاری وجود دارد برگردانده می‌شود، با این شرط که عنوان فرم "فرم دوم" باشد. 

	@(this.Where(Children.Form.Subject =="فرم دوم" ).Select(Children.Form.polformat@typeb));

#### مثال 9:<br>
با این دستور فیلد انتخاب شده با مقدار فیلد اضافه‌ای با کلید polformat که در فرم موجود در سابقه آیتم جاری وجود دارد مقداردهی می‌شود، با شرط این که در آن فرم فیلدی با کلید number  دارای مقدار 99 باشد.

	@(this.Where(Children.Form.number == 99).Select(Children.Form.polformat@typeb));

#### مثال 10:<br>
با این دستور فیلد انتخاب شده با مقدار فیلد اضافه‌ای با کلید polformat که در فرم موجود در سوابقی آیتم جاری وجود دارد مقداردهی می‌شود، با این شرط که در آن فرم فیلدی با کلید number دارای مقدار 670 باشد یا فیلدی با کلید poljoin دارای مقدار 400 باشد. 

	@(this.Where(Children.Form.number == 670 || Children.Form.poljoin == 400).Select(Children.Form.polformat));

#### مثال 11:<br>
با این دستور فیلد انتخاب شده با مقدار فیلد اضافه‌ای با کلید polformat که در فرم موجود در سابقه‌ی آیتم جاری وجود دارد مقداردهی می‌شود، با این شرط که در آن فرم فیلدی با کلید npfali دارای مقدار 90  و فیلدی با کلید poljoin دارای مقدار 30 باشد یا فیلدی با کلید numfirst دارای مقدار 18 باشد. 

	@(this.Children.Form.Where(Children.Form.npfali@mytype1==90&&(Children.Form.poljoin@mytype1 == 30||Children.Form.numfirst@mytype1==18)).Select(Children.Form.polformat@mytype1));

#### مثال 12:<br>
با این دستور فیلد انتخاب شده با مقدار فیلد اضافه‌ای با کلید polformat که در فرم موجود در سابقه‌ی آیتم جاری وجود دارد مقداردهی می‌شود با این شرط که تاریخ ویرایش این سابقه بزرگ‌تر مساوی "2020-08-31" یا کوچک‌تر مساوی "2020-09-01" باشد.

	@(this.Where(Children.Form.ModifyDate >= Convert.ToDateTime("2020-08-31") && Children.Form.ModifyDate <= Convert.ToDateTime("2020-09-01")).Select(Children.Form.polformat));
	
#### مثال 13:<br>
با این دستور فیلدی با کلید polformat که در فرمی  با کلید FR123 که در سابقه‌ی آیتم جاری وجود دارد، برگردانده می‌شود.

	@(this.Select(Children.Form.polformat@FR123));

#### مثال 14:<br>
با این دستور فیلد مبلغ نهایی فاکتور برگشت از فروش که در سابقه آیتم جاری وجود دارد، برگردانده می‌شود.

	@(this.Where(Children.Invoice.BillableObjectTypeindex == 8).Select(Children.Invoice.FinalValue));

#### مثال 15:<br>
با این دستور فیلد مبلغ نهایی فاکتور برگشت از خرید که در سابقه آیتم جاری وجود دارد، برگردانده می‌شود.

	@(this.Where(Children.Invoice.BillableObjectTypeindex == 7).Select(Children.Invoice.FinalValue));
